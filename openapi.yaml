openapi: 3.0.3
info:
  title: Opal Support App API
  version: 1.0.0
  description: |
    API for managing clients and dynamic endpoints, plus a GraphQL endpoint to execute registered methods.
    Authentication is via API key with the Authorization header using the Bearer scheme.
servers:
  - url: http://localhost:3000
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
  schemas:
    Client:
      type: object
      required: [id, name, email, apiKeys, createdAt, rateLimit]
      properties:
        id:
          type: string
          example: client_1712345678901_abcd12345
        name:
          type: string
          example: Demo Client
        email:
          type: string
          format: email
          example: client@example.com
        apiKeys:
          type: array
          items:
            type: string
            example: opal_demo_key_abcd1234EFGH
        createdAt:
          type: string
          format: date-time
          example: 2024-10-01T12:00:00.000Z
        rateLimit:
          type: integer
          description: requests per minute
          example: 60
    Endpoint:
      type: object
      required: [id, name, description, code, visibility, requiredProps, createdAt, updatedAt]
      properties:
        id:
          type: string
          example: endpoint_1712345678901_abcxyz123
        name:
          type: string
          description: Method name used to invoke via GraphQL
          example: summarizeText
        description:
          type: string
        code:
          type: string
          description: JavaScript function source code string. Must evaluate to an async function with signature (params, props, context)
          example: |
            async function execute(params, props, context) {
              context.log('running');
              context.setOutput({ ok: true });
            }
        visibility:
          type: string
          enum: [public, private]
        requiredProps:
          type: array
          items:
            type: string
          example: ["openaiApiKey"]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    ExecuteMethodInput:
      type: object
      required: [methodName, params, props]
      properties:
        methodName:
          type: string
          description: Name of the registered method (endpoint.name)
          example: summarizeText
        params:
          type: object
          additionalProperties: {}
          example: { "text": "Hello" }
        props:
          type: object
          additionalProperties:
            type: string
          description: API keys and secrets required by the endpoint
          example: { "openaiApiKey": "sk-..." }
    ExecuteMethodResult:
      type: object
      required: [success, executionTime]
      properties:
        success:
          type: boolean
        data:
          nullable: true
        error:
          type: string
          nullable: true
        executionTime:
          type: integer
          description: milliseconds
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
    GraphQLErrorResponse:
      type: object
      properties:
        errors:
          type: array
          items:
            type: object
            properties:
              message:
                type: string
paths:
  /api/clients:
    post:
      summary: Create client
      description: Create a new client with optional API keys and rate limit.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email]
              properties:
                name:
                  type: string
                email:
                  type: string
                rateLimit:
                  type: integer
                apiKeys:
                  type: array
                  items:
                    type: string
            examples:
              default:
                value:
                  name: Demo Client
                  email: client@example.com
                  rateLimit: 60
                  apiKeys: ["opal_demo_key_abcd1234EFGH"]
      responses:
        '200':
          description: Client created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  client:
                    $ref: '#/components/schemas/Client'
              examples:
                success:
                  value:
                    success: true
                    client:
                      id: client_1712345678901_abcd12345
                      name: Demo Client
                      email: client@example.com
                      apiKeys: ["opal_demo_key_abcd1234EFGH"]
                      createdAt: 2024-10-01T12:00:00.000Z
                      rateLimit: 60
        '500':
          description: Error creating client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update client
      description: Update an existing client by ID.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                name:
                  type: string
                email:
                  type: string
                rateLimit:
                  type: integer
                apiKeys:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Client updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  client:
                    $ref: '#/components/schemas/Client'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error updating client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete client
      description: Delete client by ID query parameter.
      security: []
      parameters:
        - in: query
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Client deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Missing client ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error deleting client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/endpoints:
    post:
      summary: Create endpoint
      description: Create a new dynamic endpoint (method) configuration.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, description, code, visibility]
              properties:
                name:
                  type: string
                description:
                  type: string
                code:
                  type: string
                visibility:
                  type: string
                  enum: [public, private]
                requiredProps:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Endpoint created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  endpoint:
                    $ref: '#/components/schemas/Endpoint'
        '500':
          description: Error creating endpoint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update endpoint
      description: Update an existing endpoint by ID.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                name:
                  type: string
                description:
                  type: string
                code:
                  type: string
                visibility:
                  type: string
                  enum: [public, private]
                requiredProps:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Endpoint updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  endpoint:
                    $ref: '#/components/schemas/Endpoint'
        '404':
          description: Endpoint not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error updating endpoint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete endpoint
      description: Delete endpoint by ID query parameter.
      security: []
      parameters:
        - in: query
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Endpoint deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Missing endpoint ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error deleting endpoint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/graphql:
    post:
      summary: Execute registered method via GraphQL
      description: |
        GraphQL endpoint. Only the executeMethod mutation is supported based on the code.
        Use a JSON body with a GraphQL query and top-level variables.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                  description: GraphQL mutation string. The field is named executeMethod (lowercase e).
                  example: |
                    mutation Execute($methodName: String!, $params: JSON!, $props: JSON!) {
                      executeMethod(methodName: $methodName, params: $params, props: $props) {
                        success
                        data
                        error
                        executionTime
                      }
                    }
                variables:
                  type: object
                  properties:
                    methodName:
                      type: string
                      example: summarizeText
                    params:
                      type: object
                      additionalProperties: {}
                      example: { "text": "Hello" }
                    props:
                      type: object
                      additionalProperties:
                        type: string
                      example: { "openaiApiKey": "sk-..." }
      responses:
        '200':
          description: Successful execution
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      executeMethod:
                        $ref: '#/components/schemas/ExecuteMethodResult'
              examples:
                success:
                  value:
                    data:
                      executeMethod:
                        success: true
                        data: { result: "ok" }
                        executionTime: 123
        '400':
          description: Validation error or unsupported operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQLErrorResponse'
        '401':
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQLErrorResponse'
        '404':
          description: Method not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQLErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQLErrorResponse'
      security:
        - bearerAuth: []
      x-codeSamples:
        - lang: curl
          label: Execute method
          source: |
            curl -X POST \
              http://localhost:3000/api/graphql \
              -H 'Content-Type: application/json' \
              -H 'Authorization: Bearer opal_test_key_abcd1234EFGH' \
              -d '{
                "query": "mutation Execute($methodName: String!, $params: JSON!, $props: JSON!) { executeMethod(methodName: $methodName, params: $params, props: $props) { success data error executionTime } }",
                "variables": {
                  "methodName": "summarizeText",
                  "params": { "text": "Hello" },
                  "props": { "openaiApiKey": "sk-..." }
                }
              }'
